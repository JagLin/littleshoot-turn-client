<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
    <!--
        The NIO selector for the locally-running TURN server that proxies TURN
        client connections.
    -->
    <bean id="localSelectorManager"
          class="org.lastbamboo.common.nio.SelectorManagerImpl">
          <constructor-arg><value>Local-TURN-Selector</value></constructor-arg>
          </bean>

    <!--
        The local proxy port setting.
    -->
    <bean id="turnLocalProxyPortSetting"
          class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
        <property name="staticField">
            <value>org.lastbamboo.client.sip.turn.TurnClientSettings.LOCAL_TURN_PROXY_PORT</value>
            </property>
        </bean>

    <!--
        The local proxy port.
    -->
    <bean id="turnLocalProxyPort"
          factory-bean="turnLocalProxyPortSetting"
          factory-method="getValue"/>

    <!--
        The object that creates TURN sockets through the locally running TURN
        client proxy server.
    -->
    <bean id="turnReaderWriterFactory"
          class="org.lastbamboo.common.turn.client.TurnReaderWriterFactoryImpl">
        <constructor-arg>
        	<ref local="localSelectorManager"/>
        	</constructor-arg>
        </bean>

    <!--
        This is the local NIO server for accepting connections locally when
        TURN Data Indication messages arrive.  This allows us to give the
        web server a real Java socket to read from and to write to.  We then
        read what the web server sends locally and wrap it in TURN Send Request
        messages to send on to the TURN server.
    -->
    <bean id="localTurnProxy"
          class="org.lastbamboo.common.nio.NioServerImpl"
          init-method="startServer">
        <constructor-arg>
            <ref local="turnLocalProxyPort"/>
            </constructor-arg>
        <constructor-arg>
            <ref local="localSelectorManager"/>
            </constructor-arg>
        <constructor-arg>
            <ref local="turnReaderWriterFactory"/>
            </constructor-arg>
        </bean>

    <!--
        The message handler factory to use for processing TURN messages.
    -->
    <bean id="turnClientMessageHandlerFactory"
          class="org.lastbamboo.common.turn.client.message.reader.ClientTurnMessageReaderFactory">
        <property name="turnMessageFactory">
            <ref bean="turnMessageFactory"/>
            </property>
        <property name="attributesReader">
            <ref bean="turnAttributesReader"/>
            </property>
        </bean>

    <!--
        The object that tracks TURN servers.
    -->
    <bean id="turnServerTracker"
          class="org.lastbamboo.common.turn.client.TurnServerTrackerImpl"/>

    <!--
        The object that loads TURN servers from disk.
    -->
    <bean id="turnServerLoader"
          class="org.lastbamboo.common.turn.client.TurnServerLoaderImpl">
        <property name="turnServerTracker">
            <ref local="turnServerTracker"/>
            </property>
        </bean>

    <!--
        The object that connects to TURN servers.
    -->
    <bean id="turnServerConnector"
          class="org.lastbamboo.common.nio.NioServerConnector">
        <constructor-arg index="0">
            <ref bean="selectorManager"/>
            </constructor-arg>
        </bean>

    <!--
        The object that establishes TURN server connections.  This is the
        interface used by the connection maintainer to maintain multiple TURN
        server connections.
    -->
    <bean id="turnServerConnectionEstablisher"
          class="org.lastbamboo.common.turn.client.TurnServerConnectionEstablisher">
        <constructor-arg>
            <ref bean="turnAllocationManager"/>
            </constructor-arg>
        </bean>

    <!--
        The object that manages address allocations with TURN servers.
    -->
    <bean id="turnAllocationManager"
          class="org.lastbamboo.common.turn.client.TurnAllocationManagerImpl">
        <constructor-arg index="0">
            <ref bean="turnMessageFactory"/>
            </constructor-arg>
        <constructor-arg index="1">
            <ref local="turnServerConnector"/>
            </constructor-arg>
        <constructor-arg index="2">
            <ref local="turnClientMessageHandlerFactory"/>
            </constructor-arg>
        <constructor-arg index="3">
            <ref local="turnReaderWriterFactory"/>
            </constructor-arg>
        <constructor-arg index="4">
            <ref bean="turnLocalPortProvider"/>
            </constructor-arg>
        <property name="socketHandler">
            <ref bean="httpSocketHandler"/>
            </property>
        </bean>

    </beans>
